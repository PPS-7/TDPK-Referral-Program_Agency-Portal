<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>TDPK International Services â€“ Referral Agency Portal</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      background: linear-gradient(135deg, #f0f4f8, #d9e4f5);
      font-family: 'Inter', sans-serif;
    }
    .btn-primary {
      background-color: #2563eb;
      color: white;
    }
    .btn-primary:hover {
      background-color: #1d4ed8;
    }
  </style>
</head>
<body class="min-h-screen flex items-center justify-center">

  <!-- Login Screen -->
  <div id="login-screen" class="max-w-md mx-auto bg-white p-8 rounded-lg shadow-lg">
    <img src="https://placehold.co/400x150/52d242/ffffff?text=TDPK+International+Services" 
         alt="TDPK International Services" 
         class="mx-auto mb-6 rounded-xl shadow-md">

    <h1 class="text-2xl font-bold mb-6 text-center text-gray-900">Referral Agency Portal</h1>

    <form id="login-form" class="space-y-6">
      <div class="space-y-4 w-full">
        <div>
          <label for="agency-name" class="block text-sm font-medium text-gray-700">Agency Name</label>
          <input type="text" id="agency-name" placeholder="Enter your agency name" required
            class="mt-1 w-full rounded-md border border-gray-300 p-3 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm">
        </div>

        <div>
          <label for="password" class="block text-sm font-medium text-gray-700">Password</label>
          <input type="password" id="password" placeholder="Enter your password" required
            class="mt-1 w-full rounded-md border border-gray-300 p-3 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm">
        </div>

        <button type="submit" id="login-button" disabled
          class="w-full py-3 px-4 rounded-md shadow-sm text-sm font-medium btn-primary focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:bg-gray-400">
          Loading...
        </button>

        <div id="error-message" class="text-red-500 text-sm text-center"></div>
      </div>
    </form>
  </div>

  <!-- Dashboard -->
  <div id="dashboard" class="hidden max-w-4xl mx-auto bg-white p-8 rounded-lg shadow-lg">
    <h2 class="text-2xl font-bold mb-6 text-gray-900">Welcome, <span id="agency-display"></span></h2>
    <div id="sheet-links" class="space-y-4"></div>
    <button id="logout-button" class="mt-6 px-4 py-2 rounded-md bg-gray-700 text-white hover:bg-gray-900">Logout</button>
  </div>

  <script>
    const LOGIN_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTfAgz53smE06zD57K1XB79aHtLn5UVSvTd0I_RQCnfl-HaEll4cJfaPYwhGGNqrxOrUdRrQ_TMrl-E/pub?gid=2106440009&single=true&output=csv";
    const REFERRAL_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSve5MYbZ7TUkDNHpYyWIHoi8mF32dFuEMmm2DCZTTd0o2gsWFRBG66ju9YKczVSrF1AxygZqvWwJ6K/pub?gid=1741255249&single=true&output=csv";

    const loginForm = document.getElementById("login-form");
    const loginButton = document.getElementById("login-button");
    const errorMessage = document.getElementById("error-message");
    const loginScreen = document.getElementById("login-screen");
    const dashboard = document.getElementById("dashboard");
    const agencyDisplay = document.getElementById("agency-display");
    const sheetLinks = document.getElementById("sheet-links");
    const logoutButton = document.getElementById("logout-button");

    window.addEventListener("load", () => {
      loginButton.disabled = false;
      loginButton.textContent = "Login";
    });

    async function fetchCSV(url) {
      const res = await fetch(url);
      const text = await res.text();
      return text.split("\n").slice(1).map(row => row.split(",").map(c => c.trim()));
    }

    loginForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      errorMessage.textContent = "";
      loginButton.disabled = true;
      loginButton.textContent = "Checking...";

      const agencyName = document.getElementById("agency-name").value.trim();
      const password = document.getElementById("password").value.trim();

      try {
        // Fetch login sheet
        const creds = await fetchCSV(LOGIN_CSV);
        const match = creds.find(row => row[0] === agencyName && row[1] === password);

        if (match) {
          // Show dashboard
          loginScreen.classList.add("hidden");
          dashboard.classList.remove("hidden");
          agencyDisplay.textContent = agencyName;

          // Fetch referral data
          const data = await fetchCSV(REFERRAL_CSV);
          sheetLinks.innerHTML = "";

          data.filter(row => row[0] === agencyName).forEach(row => {
            const sheetName = row[1];
            const sheetUrl = row[2];
            const link = document.createElement("a");
            link.href = sheetUrl;
            link.target = "_blank";
            link.className = "block p-4 bg-blue-100 rounded hover:bg-blue-200";
            link.textContent = sheetName;
            sheetLinks.appendChild(link);
          });
        } else {
          errorMessage.textContent = "Invalid agency name or password.";
        }
      } catch (err) {
        console.error(err);
        errorMessage.textContent = "Error connecting to server.";
      } finally {
        loginButton.disabled = false;
        loginButton.textContent = "Login";
      }
    });

    logoutButton.addEventListener("click", () => {
      dashboard.classList.add("hidden");
      loginScreen.classList.remove("hidden");
      loginForm.reset();
      errorMessage.textContent = "";
    });
  </script>
</body>
</html>
